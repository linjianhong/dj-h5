"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}();!function(e,t,n){function o(){return a.load(),a}function r(e){return a.save(e),a}e.module("dj-login",["ngRoute","dj-wx"]);var i=t.theSiteConfig=e.extend({localStorage_KEY_UserToken:"__jdyhy_user_token__"},t.theSiteConfig),a={data:{},load:function(){var e=i.localStorage_KEY_UserToken;return a.data=JSON.parse(localStorage.getItem(e)||"{}"),a},save:function(e){var t=i.localStorage_KEY_UserToken;localStorage.removeItem(t),localStorage.setItem(t,JSON.stringify(a.data=e))},hasToken:function(){return a.data&&a.data.tokenid&&a.data.token},timestampOffset:0,adjustTimestamp:function(e){var t=new Date,n=Math.round(t.getTime()/1e3);a.timestampOffset=e-n},signToken:function(){a.load();var e=a.data.tokenid,t=a.data.token;if(!e||!t)return{};var n=new Date,o=Math.round(n.getTime()/1e3);return o+=a.timestampOffset,{tokenid:e,timestamp:o,sign:md5(t+o)}}};t.theSiteConfig.getUserToken=o,e.module("dj-login").provider("UserToken",function(){this.reload=o,this.$get=function(){return{reload:o,save:r}}})}(angular,window),function(e,t,n){var o,r=/micromessenger/i.test(navigator.userAgent),i=location.origin.length>12&&location.origin.indexOf("192.168")<0&&r,a=e.module("wx-jssdk",[]),s=8e4;a.run(["$http","$q",function(e,n){o=function(){if(!i)return n.reject("not wx");if(o.promise)return n.when(o.promise);var r=n.defer(),a=t.theSiteConfig&&t.theSiteConfig.wx_app.wx.name||"pgy-wx",s=location.href.split("#")[0];return e.post("app/jsapi_sign",{name:a,url:encodeURIComponent(s)}).then(function(e){var t=e.datas.config;if(!t)return void r.reject("config error!");wx.config({debug:!1,appId:t.appId,timestamp:t.timestamp,nonceStr:t.nonceStr,signature:t.signature,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ","onMenuShareWeibo","onMenuShareQZone","startRecord","stopRecord","onVoiceRecordEnd","playVoice","pauseVoice","stopVoice","onVoicePlayEnd","uploadVoice","downloadVoice","chooseImage","previewImage","uploadImage","downloadImage","translateVoice","getNetworkType","openLocation","getLocation","hideOptionMenu","showOptionMenu","hideMenuItems","showMenuItems","hideAllNonBaseMenuItem","showAllNonBaseMenuItem","closeWindow","scanQRCode","chooseWXPay"]}),wx.ready(function(){r.resolve(o.promise=wx)})}).catch(function(e){r.reject("getWjSign error!")}),o.promise=r.promise}}]),a.run(["$rootScope","$http","$q","sign",function(e,n,r,i){i.registerHttpHook({match:/^扫描二维码$/,hookRequest:function(e,t){var n=r.defer();return o().then(function(e){e.scanQRCode({needResult:1,scanType:["qrCode","barCode"],success:function(e){var t=e.resultStr;n.resolve(t)},fail:function(e){n.reject(e)}})}).catch(function(e){n.resolve("10"+ ++s)}),t.resolve(n.promise)}}),i.registerHttpHook({match:/^模拟扫描二维码$/,hookRequest:function(e,n){var o=r.defer();return t.setTimeout(function(){o.resolve(e.data||"模拟数据")},120),n.resolve(o.promise)}})}])}(angular,window),function(){angular.module("dj-wx",["ngRoute"])}(),function(e,t,n){e.module("dj-LocalStorageTable",[]).factory("LocalStorageTable",["$q",function(n){return function(){function o(e){_classCallCheck(this,o),this.tableName=e,this.initTable()}return _createClass(o,[{key:"initTable",value:function(){var e=this,n=t.localStorage.getItem(this.tableName)||JSON.stringify({rows:[]});this.data=JSON.parse(n),this.rows=this.data.rows,this.maxId=0,this.rows.map(function(t){t.id>e.maxId&&(e.maxId=t.id)})}},{key:"autoInsertId",value:function(){return++this.maxId}},{key:"saveToLocalStorage",value:function(){t.localStorage.removeItem(this.tableName),t.localStorage.setItem(this.tableName,JSON.stringify(this.data))}},{key:"insert",value:function(t,o){var r=this.autoInsertId();return this.rows.push(e.extend({id:r},t)),!o&&this.saveToLocalStorage(),n.when(r)}},{key:"select",value:function(e){e=e||{};var t=this.rows.filter(function(t){for(var n in e)if(t[n]!=e[n])return!1;return!0});return n.when(t)}},{key:"update",value:function(t,o,r){var i=this;t=t||{};var a=this.rows.filter(function(e){for(var n in t)if(e[n]!=t[n])return!1;return!0});return a[0]?(e.extend(a[0],o),this.saveToLocalStorage(),n.when(a[0])):r?this.insert(e.extend({},t,o)).then(function(e){return i.rows.find(function(t){return t.id==e})}):n.reject("无此数据")}}]),o}()}])}(angular,window),function(e,t,n){function o(t,n){return e.extend({errcode:0,datas:t},n)}function r(t,n,o){return e.extend({errcode:t,errmsg:n},o)}var i=e.module("dj-http",[]);i.config(["$httpProvider",function(t){t.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8";var n=function e(t){var n,o,r,i,a,s,u,c="";for(n in t)if((o=t[n])instanceof Array)for(u=0;u<o.length;++u)a=o[u],r=n+"["+u+"]",s={},s[r]=a,c+=e(s)+"&";else if(o instanceof Object)for(i in o)a=o[i],r=n+"["+i+"]",s={},s[r]=a,c+=e(s)+"&";else void 0!==o&&null!==o&&(c+=encodeURIComponent(n)+"="+encodeURIComponent(o)+"&");return c.length?c.substr(0,c.length-1):c};t.defaults.transformRequest=[function(t){return e.isObject(t)&&"[object File]"!==String(t)?n(t):t}]}]),i.config(["$qProvider",function(e){e.errorOnUnhandledRejections(!1)}]);var a;i.run(["$q","$http",function(e,t){a=function(e){if(!(this instanceof a))return new a(e);this.data=e},a.OK=o,a.error=r,a.$q=e,a.$http=t,a.reject=function(t){return new a(e.reject(t))},a.resolve=function(t){return new a(e.when(t))},a.prototype={OK:o,error:r,$q:e,$http:t}}]),i.provider("sign",[function(){function e(t){e.fn=t}function t(e){t.fn=e}function n(t){for(var n,o,r=u.length;r--;){var i=u[r];if(i.match&&i.hookRequest&&(o=t.url.match(i.match))&&(n=i.hookRequest(t,a,o)))return n}return e.fn(t,a)}function i(e,n){for(var o,r=u.length;r--;){var i=u[r];if(i.match&&i.hookResponse&&e.config.urlBase.match(i.match)&&(o=i.hookResponse(e,n)))return o}return t.fn(e,n)}var s="./";this.setApiRoot=function(e){s=e,/\/$/.test(s)||(s+="/")};var u=[],c=this.registerHttpHook=function(e){return u.indexOf(e)<0&&u.push(e),e};this.unRegisterHttpHook=function(e){u.splice(u.indexOf(e),1)},this.registerDefaultRequestHook=e,this.registerDefaultRequestHook(function(e,t){var n=e.url,o=e.data;return/^(http(s)?\:)?\/\//.test(n)||(n=s+n),{url:n,data:o}}),this.registerDefaultResponseHook=t,this.registerDefaultResponseHook(function(e,t){return t.when(e.data).then(function(e){return e&&0==+e.errcode?e:t.reject(e)})}),this.$get=function(){return{registerHttpHook:c,OK:o,error:r,hookRequest:n,hookResponse:i,apiRoot:s||"./"}}}]),i.factory("DJHttpHook",["$q","$rootScope","sign",function(e,t,n){return{request:function(t){if(t.urlBase=t.url,"POST"!=t.method||!1===t.hook)return t;var o=t.hook||{};if(!1===o.hookRequest)return t;var r=n.hookRequest(t,a);return r instanceof a?e.reject(r):("url"==o.hookRequest?t.url=r.url:"sign"==o.hookRequest?t.data=r.post:(t.data=r.post,t.url=r.url),t)},requestError:function(t){return e.reject(t)},response:function(t){return"POST"!=t.config.method||!1===t.config.hook?t:!1===(t.config.hook||{}).hookResponse?t:n.hookResponse(t,e)},responseError:function(t){return t instanceof a?e.when(t.data):e.reject(t)}}}]),i.config(["$httpProvider",function(e){e.interceptors.push("DJHttpHook")}])}(angular,window),function(e,t,n){function o(e,t,n){var o=this;this.$onInit=function(r,i,a){var s="login-"+o.mode;t.html("<"+s+' page-to="$ctrl.pageTo"></'+s+">"),n(t.contents())(e)}}new Date,/micromessenger/i.test(navigator.userAgent);t.module("dj-login").component("loginHost",{template:"",bindings:{mode:"<",pageTo:"<"},controller:["$scope","$element","$compile",o]})}(window,angular),function(e,t,n){function o(e,t,n){e.loginMode=t.login_mode||"wx-auth",e.pageTo=n.search().pageTo}t.module("dj-login").config(["$routeProvider",function(e){e.when("/login",{redirectTo:"/login/wx-auth"}).when("/login-test",{pageTitle:"登录测试",requireLogin:!1,template:"登录测试"}).when("/login/:login_mode",{pageTitle:"登录",requireLogin:!1,template:'<login-host mode="loginMode" page-to="pageTo"></login-host>',controller:["$scope","$routeParams","$location",o]})}])}(window,angular),function(e,t,n){function o(e,n,o){function s(e){new WxLogin(t.extend({},e,{id:i,scope:"snsapi_login",style:"",href:""}))}var u=this;if(a){var c=this.pageTo;/^\/login(\/.*)?$/.test(c)&&(c="/");var l=r(location.href,c,"wx"),f="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+l.appid+"&redirect_uri="+l.redirect_uri+"&response_type=code&scope=snsapi_userinfo&state="+l.state+"#wechat_redirect";return void(location.href=f)}this.$onInit=function(){var e=r(location.href,u.pageTo,"web");"undefined"==typeof WxLogin?o.jsonp("https://res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js").finally(function(t){s(e)}):s(e)}}function r(n,o,r){var i=(/\#\!/.test(e.location.hash)?"#!":"#")+"/wx-code-login",a=t.extend({},e.theSiteConfig),s=a.wx_app[r].appid,u=encodeURIComponent(btoa(o)),c=a.wx_app[r].name,l=encodeURIComponent(btoa(n.split("#")[0]+i));return{appid:s,state:u,redirect_uri:a.wx_authApiBase+"/"+c+"/"+l}}var i="wx-lg_cnt_"+ +new Date,a=/micromessenger/i.test(navigator.userAgent);t.module("dj-wx").config(["$sceDelegateProvider",function(e){var t=e.resourceUrlWhitelist();t.push("https://res.wx.qq.com/**"),e.resourceUrlWhitelist(t)}]).component("loginWxAuth",{template:'<div id="'+i+'" class="text-center">Loading weixin ...</div>',bindings:{pageTo:"<"},controller:["$scope","$location","$http",o]})}(window,angular),function(e,t,n){function o(t,n,o,r){var i=n.search();o.post("app/wx_code_login",{name:i.app,scene:i.scene,code:i.code},{hook:{hookRequest:"url"}}).then(function(t){r.save(t.datas),o.post("用户登录",{token:t.datas}),location.hash=(/\#\!/.test(e.location.hash)?"#!":"#")+i.pageTo}).catch(function(e){})}t.module("dj-wx").config(["$routeProvider",function(e){e.when("/wx-code-login",{pageTitle:"微信code登录",requireLogin:!1,template:"正在登录中...",controller:["$scope","$location","$http","UserToken",o]})}])}(window,angular);