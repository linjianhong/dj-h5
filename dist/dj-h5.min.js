"use strict";!function(e,o,n){var t,i=/micromessenger/i.test(navigator.userAgent),a=location.origin.length>12&&location.origin.indexOf("192.168")<0&&i,r=e.module("wx-jssdk",[]),s=8e4;r.run(["$http","$q",function(e,n){t=function(){if(!a)return n.reject("not wx");if(t.promise)return n.when(t.promise);var i=n.defer(),r=o.theSiteConfig&&o.theSiteConfig.wx_app.wx.name||"pgy-wx",s=location.href.split("#")[0];return e.post("app/jsapi_sign",{name:r,url:encodeURIComponent(s)}).then(function(e){var o=e.datas.config;if(!o)return void i.reject("config error!");wx.config({debug:!1,appId:o.appId,timestamp:o.timestamp,nonceStr:o.nonceStr,signature:o.signature,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ","onMenuShareWeibo","onMenuShareQZone","startRecord","stopRecord","onVoiceRecordEnd","playVoice","pauseVoice","stopVoice","onVoicePlayEnd","uploadVoice","downloadVoice","chooseImage","previewImage","uploadImage","downloadImage","translateVoice","getNetworkType","openLocation","getLocation","hideOptionMenu","showOptionMenu","hideMenuItems","showMenuItems","hideAllNonBaseMenuItem","showAllNonBaseMenuItem","closeWindow","scanQRCode","chooseWXPay"]}),wx.ready(function(){i.resolve(t.promise=wx)})}).catch(function(e){i.reject("getWjSign error!")}),t.promise=i.promise}}]),r.run(["$rootScope","$http","$q","sign",function(e,n,i,a){a.registerHttpHook({match:/^扫描二维码$/,hookRequest:function(e,o){var n=i.defer();return t().then(function(e){e.scanQRCode({needResult:1,scanType:["qrCode","barCode"],success:function(e){var o=e.resultStr;n.resolve(o)},fail:function(e){n.reject(e)}})}).catch(function(e){n.resolve("10"+ ++s)}),o.resolve(n.promise)}}),a.registerHttpHook({match:/^模拟扫描二维码$/,hookRequest:function(e,n){var t=i.defer();return o.setTimeout(function(){t.resolve(e.data||"模拟数据")},120),n.resolve(t.promise)}})}])}(angular,window),function(e,o,n){function t(){return r.load(),r}function i(e){return r.save(e),r}e.module("dj-login",["ngRoute","dj-wx"]);var a=o.theSiteConfig=e.extend({localStorage_KEY_UserToken:"__jdyhy_user_token__"},o.theSiteConfig),r={data:{},load:function(){var e=a.localStorage_KEY_UserToken;return r.data=JSON.parse(localStorage.getItem(e)||"{}"),r},save:function(e){var o=a.localStorage_KEY_UserToken;localStorage.removeItem(o),localStorage.setItem(o,JSON.stringify(r.data=e))},hasToken:function(){return r.data&&r.data.tokenid&&r.data.token},timestampOffset:0,adjustTimestamp:function(e){var o=new Date,n=Math.round(o.getTime()/1e3);r.timestampOffset=e-n},signToken:function(){r.load();var e=r.data.tokenid,o=r.data.token;if(!e||!o)return{};var n=new Date,t=Math.round(n.getTime()/1e3);return t+=r.timestampOffset,{tokenid:e,timestamp:t,sign:md5(o+t)}}};o.theSiteConfig.getUserToken=t,e.module("dj-login").provider("UserToken",function(){this.reload=t,this.$get=function(){return{reload:t,save:i}}})}(angular,window),function(){angular.module("dj-wx",["ngRoute"])}(),function(e,o,n){function t(e,o,n){var t=this;this.$onInit=function(i,a,r){var s="login-"+t.mode;o.html("<"+s+' page-to="$ctrl.pageTo"></'+s+">"),n(o.contents())(e)}}new Date,/micromessenger/i.test(navigator.userAgent);o.module("dj-login").component("loginHost",{template:"",bindings:{mode:"<",pageTo:"<"},controller:["$scope","$element","$compile",t]})}(window,angular),function(e,o,n){function t(e,o,n){e.loginMode=o.login_mode||"wx-auth",e.pageTo=n.search().pageTo}o.module("dj-login").config(["$routeProvider",function(e){e.when("/login",{redirectTo:"/login/wx-auth"}).when("/login-test",{pageTitle:"登录测试",requireLogin:!1,template:"登录测试"}).when("/login/:login_mode",{pageTitle:"登录",requireLogin:!1,template:'<login-host mode="loginMode" page-to="pageTo"></login-host>',controller:["$scope","$routeParams","$location",t]})}])}(window,angular),function(e,o,n){function t(e,n,t){function s(e){new WxLogin(o.extend({},e,{id:a,scope:"snsapi_login",style:"",href:""}))}var c=this;if(r){var u=this.pageTo;/^\/login(\/.*)?$/.test(u)&&(u="/");var l=i(location.href,u,"wx"),d="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+l.appid+"&redirect_uri="+l.redirect_uri+"&response_type=code&scope=snsapi_userinfo&state="+l.state+"#wechat_redirect";return void(location.href=d)}this.$onInit=function(){var e=i(location.href,c.pageTo,"web");"undefined"==typeof WxLogin?t.jsonp("https://res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js").finally(function(o){s(e)}):s(e)}}function i(n,t,i){var a=(/\#\!/.test(e.location.hash)?"#!":"#")+"/wx-code-login",r=o.extend({},e.theSiteConfig),s=r.wx_app[i].appid,c=encodeURIComponent(btoa(t)),u=r.wx_app[i].name,l=encodeURIComponent(btoa(n.split("#")[0]+a));return{appid:s,state:c,redirect_uri:r.wx_authApiBase+"/"+u+"/"+l}}var a="wx-lg_cnt_"+ +new Date,r=/micromessenger/i.test(navigator.userAgent);o.module("dj-wx").config(["$sceDelegateProvider",function(e){var o=e.resourceUrlWhitelist();o.push("https://res.wx.qq.com/**"),e.resourceUrlWhitelist(o)}]).component("loginWxAuth",{template:'<div id="'+a+'" class="text-center">Loading weixin ...</div>',bindings:{pageTo:"<"},controller:["$scope","$location","$http",t]})}(window,angular),function(e,o,n){function t(o,n,t,i){var a=n.search();t.post("app/wx_code_login",{name:a.app,scene:a.scene,code:a.code},{hook:{hookRequest:"url"}}).then(function(o){i.save(o.datas),t.post("用户登录",{token:o.datas}),location.hash=(/\#\!/.test(e.location.hash)?"#!":"#")+a.pageTo}).catch(function(e){})}o.module("dj-wx").config(["$routeProvider",function(e){e.when("/wx-code-login",{pageTitle:"微信code登录",requireLogin:!1,template:"正在登录中...",controller:["$scope","$location","$http","UserToken",t]})}])}(window,angular);